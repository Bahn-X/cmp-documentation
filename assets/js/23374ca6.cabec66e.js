(self.webpackChunkcmp_documentation_website=self.webpackChunkcmp_documentation_website||[]).push([[421],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return d},kt:function(){return g}});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=c(n),g=i,m=u["".concat(l,".").concat(g)]||u[g]||p[g]||r;return n?a.createElement(m,o(o({ref:t},d),{},{components:n})):a.createElement(m,o({ref:t},d))}));function g(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var c=2;c<r;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},8813:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return o},metadata:function(){return s},toc:function(){return l},default:function(){return d}});var a=n(2122),i=n(9756),r=(n(7294),n(3905)),o={sidebar_position:1},s={unversionedId:"README",id:"README",isDocsHomePage:!1,title:"DB CMP Browser SDK",description:"Deutsche Bahn consent management platform browser SDK",source:"@site/docs/README.md",sourceDirName:".",slug:"/README",permalink:"/cmp-documentation/docs/README",version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"defaultSidebar",next:{title:"Suppress UI on legal pages",permalink:"/cmp-documentation/docs/examples/configuration/config-legal-pages"}},l=[{value:"How it works",id:"how-it-works",children:[{value:"Case 1: Integration of DPS via script tags",id:"case-1-integration-of-dps-via-script-tags",children:[]},{value:"Case 2: Integration of DPS without using script tags",id:"case-2-integration-of-dps-without-using-script-tags",children:[]}]},{value:"Prerequisites",id:"prerequisites",children:[{value:"Gather services you need consent for",id:"gather-services-you-need-consent-for",children:[]},{value:"Tealium tag manager",id:"tealium-tag-manager",children:[]}]},{value:"Install",id:"install",children:[{value:"Add Tealium script tag to your website",id:"add-tealium-script-tag-to-your-website",children:[]},{value:"Configuration",id:"configuration",children:[]},{value:"Migrating existing tags",id:"migrating-existing-tags",children:[]}]},{value:"API",id:"api",children:[{value:"Usage",id:"usage",children:[]},{value:"Possible pitfalls",id:"possible-pitfalls",children:[]}]}],c={toc:l};function d(e){var t=e.components,n=(0,i.Z)(e,["components"]);return(0,r.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Deutsche Bahn consent management platform browser SDK")),(0,r.kt)("p",null,"The goal of this SDK is to offer access to the underlying consent management platform (CMP) in the browser.\nBy using a CMP, we ensure that websites use the same standardized way of managing consent, which is aligned with Konzerndatenschutz (privacy officer) according to legal requirements.\nThe current CMP in use is ",(0,r.kt)("a",{parentName:"p",href:"https://usercentrics.com/de/website-consent-management/"},"Usercentrics"),"."),(0,r.kt)("h2",{id:"how-it-works"},"How it works"),(0,r.kt)("p",null,"The CMP and this SDK will be embedded into a website via a tag manager (Tealium).\nThis makes the integration of Tealium mandatory."),(0,r.kt)("p",null,"Ideally, loading the CMP via a script tag handles most of the cases, i.e. where external DPS are integrated with script tags as well (see Case 1 below).\nFor other cases, e.g. custom implementations, there might be the need to interact with the CMP directly via this SDK (see Case 2)."),(0,r.kt)("h3",{id:"case-1-integration-of-dps-via-script-tags"},"Case 1: Integration of DPS via script tags"),(0,r.kt)("p",null,"A website integrates a DPS via script tags (",(0,r.kt)("inlineCode",{parentName:"p"},"<script>...<\/script>"),")."),(0,r.kt)("p",null,"Loading of scripts can be fully managed by Tealium using the Usercentrics extension.\nThe script tags need to be added to Tealium and mapped to a DPS (created in Usercentrics).\nTealium will then automatically add or remove the script from the website based on the current consent status."),(0,r.kt)("h3",{id:"case-2-integration-of-dps-without-using-script-tags"},"Case 2: Integration of DPS without using script tags"),(0,r.kt)("p",null,"A website integrates a DPS via a manual or customized solution, e.g. using an ",(0,r.kt)("inlineCode",{parentName:"p"},"npm")," library."),(0,r.kt)("p",null,"Developers need to use the CMP SDK and query the consent for the given DPS before exposing (user)data.\nFor example when using an analytics library, before firing events it should be checked if there is valid consent."),(0,r.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,r.kt)("h3",{id:"gather-services-you-need-consent-for"},"Gather services you need consent for"),(0,r.kt)("p",null,"Find and/or add the data processing services (DPS) consent is needed for in the CMP. The CMP usually offers the most common DPS out of the box.\nIf you use a custom DPS, it has to be added to the CMP first.\nThese services will then appear in the consent layer, so users can manage their privacy settings (opt-in)."),(0,r.kt)("p",null,"Likewise, these services can then be managed by the SDK/CMP (loading scripts, listening to consent events, etc.)."),(0,r.kt)("h3",{id:"tealium-tag-manager"},"Tealium tag manager"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://tealium.com/products/tealium-iq-tag-management-system/"},"Tealium"),' is used as tag manager to ship scripts (i.e. "tags") to a website.\nBy doing this, we can deliver the consent layer, as well as offer access to the underlying CMP (via this SDK) with only one additional script tag.'),(0,r.kt)("p",null,"You'll need the correct account and profile information before you start integrating Tealium and the CMP."),(0,r.kt)("h2",{id:"install"},"Install"),(0,r.kt)("h3",{id:"add-tealium-script-tag-to-your-website"},"Add Tealium script tag to your website"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"see: ",(0,r.kt)("a",{parentName:"p",href:"https://docs.tealium.com/platforms/javascript/install/"},"https://docs.tealium.com/platforms/javascript/install/"))),(0,r.kt)("p",null,"Adding the following snippet to a website will load Tealium and initialize its datalayer, the ",(0,r.kt)("inlineCode",{parentName:"p"},"utag_data")," object (UDO):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-html"},"<body>\n  \x3c!-- Tealium universal data object --\x3e\n  <script type=\"text/javascript\">\n    var utag_data = {};\n  <\/script>\n\n  \x3c!-- Tealium tag --\x3e\n  <script type=\"text/javascript\">\n      (function(a,b,c,d){\n          a='https://tags.tiqcdn.com/utag/ACCOUNT/PROFILE/STAGE/utag.js';\n          b=document;c='script';d=b.createElement(c);d.src=a;d.type='text/java'+c;d.async=true;\n          a=b.getElementsByTagName(c)[0];a.parentNode.insertBefore(d,a);\n      })();\n  <\/script>\n</body>\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Note:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"ACCOUNT")," is the Tealium account used"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"PROFILE")," is the currently used Tealium profile, i.e. the profile used to manage your website"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"STAGE")," is the current stage being used: ",(0,r.kt)("inlineCode",{parentName:"li"},"prod"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"qa")," or ",(0,r.kt)("inlineCode",{parentName:"li"},"dev"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u26a0\ufe0f ",(0,r.kt)("strong",{parentName:"li"},"be careful to select the proper stage for your deployment target")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"dev")," can include experimental features and should only be used for development"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"qa")," is meant as staging environment for testing"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"prod")," is considered stable and should be used for production")))),(0,r.kt)("h3",{id:"configuration"},"Configuration"),(0,r.kt)("p",null,"It is possible to configure some consent layer behaviour before loading the CMP, e.g. suppressing the UI on certain pages or disabling the auto-reload after consent changes.\nThe configuration uses Tealium's data layer, the ",(0,r.kt)("inlineCode",{parentName:"p"},"utag_data")," object (UDO)."),(0,r.kt)("p",null,"To use the configuration, add the ",(0,r.kt)("a",{parentName:"p",href:"/cmp-documentation/docs/api/interfaces/cmpoptions"},"options")," to your existing ",(0,r.kt)("inlineCode",{parentName:"p"},"utag_data")," object.\nExample:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-html"},"<script type=\"text/javascript\">\n  var utag_data = {\n    cmp_privacy_url: '/imprint',\n    // see list of options\n  };\n<\/script>\n")),(0,r.kt)("h3",{id:"migrating-existing-tags"},"Migrating existing tags"),(0,r.kt)("p",null,"After adding the tag manager, existing scripts need to be migrated.\nInstead of adding them directly to the website, they will be loaded via Tealium:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"add Tealium tag"),(0,r.kt)("li",{parentName:"ul"},"remove old tag(s)"),(0,r.kt)("li",{parentName:"ul"},"add (and configure) tag(s) to Tealium"),(0,r.kt)("li",{parentName:"ul"},"map tag(s) to a data processing service in the CMP"),(0,r.kt)("li",{parentName:"ul"},"tag manager will then manage tags based on user consent")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"\u26a0\ufe0f As tags are loaded dynamically based on consent, you have to make sure your code still works without these external scripts, e.g. before accessing global variables added by them."),(0,r.kt)("p",{parentName:"blockquote"},'By default, the page will reload after a consent change (= removal/addition of a script tag) to make sure the page is in a "fresh" state.')),(0,r.kt)("p",null,"Depending on how script tags get loaded and configured, simply replacing the tags might not be enough.\nIdeally, the external script simply gets loaded by Tealium while being configured on the website (after making sure the script was properly loaded and executed).\nFor most other cases, there are predefined tags available, which can be configured in the tag manager directly."),(0,r.kt)("p",null,"There are some examples of services being migrated to Tealium and CMP in the ",(0,r.kt)("inlineCode",{parentName:"p"},"docs")," folder."),(0,r.kt)("h2",{id:"api"},"API"),(0,r.kt)("p",null,"The main purpose of this SDK is to allow programmatic interaction with the underlying CMP, which means that the basic functionality of the UI will be available through this API.\nIt is ",(0,r.kt)("em",{parentName:"p"},"not")," meant to circumvent or replace the usage of the UI."),(0,r.kt)("p",null,"A documentation of the Typescript API can be found here: ",(0,r.kt)("a",{parentName:"p",href:"/cmp-documentation/docs/api/README"},"docs/api"),"."),(0,r.kt)("h3",{id:"usage"},"Usage"),(0,r.kt)("h4",{id:"as-global-window-variable"},"As global Window variable"),(0,r.kt)("p",null,"The SDK is bundled with the Tealium tag, so it can be used once the tag manager is properly loaded.\nAll methods are available from within the ",(0,r.kt)("inlineCode",{parentName:"p"},"DB_CMP")," namespace in the browser:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"// Browser console\n\nDB_CMP.isInitialized();\nDB_CMP.getServices();\n\n// In code\n\nif (typeof window !== 'undefined') {\n  // browser only\n  const { DB_CMP } = window;\n  if (DB_CMP) {\n    // ...\n  }\n}\n")),(0,r.kt)("h4",{id:"as-package"},"As package"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"\u26a0\ufe0f Currently, the package is only available via private GitHub registry. We plan to make it public soon.")),(0,r.kt)("p",null,"Alternatively you can install the package and use the SDK directly, for example using ",(0,r.kt)("inlineCode",{parentName:"p"},"yarn"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"yarn add @bahn-x/cmp-sdk\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"import { init, getServices } from '@bahn-x/cmp-sdk';\n\ninit().then(() => {\n  // use the SDK, e.g.:\n  const services = getServices();\n});\n")),(0,r.kt)("p",null,"The package also includes type definitions, so you can extend the global ",(0,r.kt)("inlineCode",{parentName:"p"},"Window")," object and use the SDK in your code:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"// for example globals.d.ts\nimport { CmpBrowserObject } from '@bahn-x/cmp-sdk';\n\ndeclare global {\n  interface Window {\n    /**\n     * NOTE: Due to the way the SDK gets loaded, this variable can be undefined,\n     * e.g. if external script tags are blocked by the browser.\n     */\n    DB_CMP?: CmpBrowserObject;\n  }\n}\n\n// somewhere-else.ts\nconst { DB_CMP } = window;\nDB_CMP?.getServices();\n")),(0,r.kt)("h3",{id:"possible-pitfalls"},"Possible pitfalls"),(0,r.kt)("p",null,"Due to the way the CMP gets loaded and initialized, there can be race conditions and/or problems accessing the SDK depending on when and how you access it:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"accessing the SDK before the CMP is completely loaded (e.g. due to a slow internet connection)"),(0,r.kt)("li",{parentName:"ul"},"script tags not being loaded at all (e.g. ad blocker blocking the tag manager)")),(0,r.kt)("p",null,"To avoid that, there are a couple approaches:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"// When accessing the global window variable,\n// check availability of the script before doing anything with it:\nconst { DB_CMP } = window;\nif (DB_CMP) {\n  // access the SDK\n}\n\n// check readiness of the SDK (doesn't counter race conditions)\nif (DB_CMP.isInitialized()) {\n  // the SDK is initialized and available\n}\n\n// wait for proper initialization by using the `init()` method\nDB_CMP.init().then(() => {\n  // the SDK is initialized and available\n});\n\n// use the custom event to wait for readiness\nwindow.addEventListener('DB_CMP_INITIALIZED', () => {\n  // the SDK is initialized and available\n});\n")))}d.isMDXComponent=!0}}]);